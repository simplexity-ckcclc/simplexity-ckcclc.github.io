<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">



  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=7.0.0">








<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="由peer的grpc请求到/protos.Endorser/ProcessProposal，在endorser里对应着protos/peer/peer.pb.go#_Endorser_ProcessProposal_Handler，进入处理方法core/endorser/endorser.go#ProcessProposal。endorser的处理过程主要分为三个阶段，preProcess, si">
<meta name="keywords" content="Hyperledger Fabric,源码分析">
<meta property="og:type" content="article">
<meta property="og:title" content="Fabric 1.4源码分析 - chaincode instantiate(3）endorser的propocessProposal主过程">
<meta property="og:url" content="https://simplexity.cn/2019/02/24/fabric-source-chaincode-instantiate-endorser-process-proposal/index.html">
<meta property="og:site_name" content="Simplexity">
<meta property="og:description" content="由peer的grpc请求到/protos.Endorser/ProcessProposal，在endorser里对应着protos/peer/peer.pb.go#_Endorser_ProcessProposal_Handler，进入处理方法core/endorser/endorser.go#ProcessProposal。endorser的处理过程主要分为三个阶段，preProcess, si">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-10-28T01:59:15.296Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fabric 1.4源码分析 - chaincode instantiate(3）endorser的propocessProposal主过程">
<meta name="twitter:description" content="由peer的grpc请求到/protos.Endorser/ProcessProposal，在endorser里对应着protos/peer/peer.pb.go#_Endorser_ProcessProposal_Handler，进入处理方法core/endorser/endorser.go#ProcessProposal。endorser的处理过程主要分为三个阶段，preProcess, si">






  <link rel="canonical" href="https://simplexity.cn/2019/02/24/fabric-source-chaincode-instantiate-endorser-process-proposal/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Fabric 1.4源码分析 - chaincode instantiate(3）endorser的propocessProposal主过程 | Simplexity</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Simplexity</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://simplexity.cn/2019/02/24/fabric-source-chaincode-instantiate-endorser-process-proposal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Travis Wong">
      <meta itemprop="description" content="Simple is Complex">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Simplexity">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Fabric 1.4源码分析 - chaincode instantiate(3）endorser的propocessProposal主过程

              
            
          </h1>
        

        <div class="post-meta">
          

          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-02-24 23:31:16" itemprop="dateCreated datePublished" datetime="2019-02-24T23:31:16+08:00">2019-02-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-10-28 09:59:15" itemprop="dateModified" datetime="2020-10-28T09:59:15+08:00">2020-10-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Hyperledger-Fabric/" itemprop="url" rel="index"><span itemprop="name">Hyperledger Fabric</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/02/24/fabric-source-chaincode-instantiate-endorser-process-proposal/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count gitment-comments-count" data-xid="/2019/02/24/fabric-source-chaincode-instantiate-endorser-process-proposal/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>由peer的grpc请求到<code>/protos.Endorser/ProcessProposal</code>，在endorser里对应着<code>protos/peer/peer.pb.go#_Endorser_ProcessProposal_Handler</code>，进入处理方法<code>core/endorser/endorser.go#ProcessProposal</code>。endorser的处理过程主要分为三个阶段，preProcess, simulate和endorse。其中，preProcess主要做校验工作，包括数据结构的完整性(header)，唯一性防止重放攻击，校验签名，对application chaincode（以后简称acc）检查ACL策略等等。这部分校验比较直观和简单，这里不做深入分析。需要注意的是，在这里还获取了TX模拟器<code>txsim, err = e.s.GetTxSimulator(chainID, txid);</code>和历史请求执行器<code>historyQueryExecutor, err = e.s.GetHistoryQueryExecutor(chainID);</code>。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GetTxSimulator returns the transaction simulator for the specified ledger</span></span><br><span class="line"><span class="comment">// a client may obtain more than one such simulator; they are made unique</span></span><br><span class="line"><span class="comment">// by way of the supplied txid</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SupportImpl)</span> <span class="title">GetTxSimulator</span><span class="params">(ledgername <span class="keyword">string</span>, txid <span class="keyword">string</span>)</span> <span class="params">(ledger.TxSimulator, error)</span></span> &#123;</span><br><span class="line">    lgr := s.Peer.GetLedger(ledgername)</span><br><span class="line">    <span class="keyword">return</span> lgr.NewTxSimulator(txid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewTxSimulator implements method in interface `txmgmt.TxMgr`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(txmgr *LockBasedTxMgr)</span> <span class="title">NewTxSimulator</span><span class="params">(txid <span class="keyword">string</span>)</span> <span class="params">(ledger.TxSimulator, error)</span></span> &#123;</span><br><span class="line">    s, err := newLockBasedTxSimulator(txmgr, txid)</span><br><span class="line">    txmgr.commitRWLock.RLock()</span><br><span class="line">    <span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个模拟器和执行器是对应于账本ledger的，也就是channel，入参ledgername就是channelId。chainless的proposals的ledger.TxSimulator和ledger.HistoryQueryExecutor都是nil。模拟器是基于锁的，在生成模拟器时，同时加上了读锁，在下一阶段simulate结束后就立即释放。同时，也生成了历史数据查询器。关于这个锁，代码里有下面一段解释。</p>
<blockquote>
<p>txsim acquires a shared lock on the stateDB. As this would impact the block commits (i.e., commit of valid write-sets to the stateDB), we must release the lock as early as possible. Hence, this txsim object is closed in simulateProposal() as soon as the tx is simulated and rwset is collected before gossip dissemination if required for privateData. </p>
</blockquote>
<a id="more"></a>
<p>接下来主要分析simulate过程。在<code>endorser.SimulateProposal</code>这个方法中，可以看到存在多处对当前chaincode是否System chaincode系统链码的判断。（注意，当前请求channel是lscc）在当前篇幅里主要分析instantiate的过程，其他的判断分支以后再详述。在<code>SimulateProposal</code>里，首先判断当前是否是scc，这里是lscc，进入分支获取<code>util.GetSysCCVersion()</code>，scc的版本固定为string常量‘latest’.<br>整个流程方法调用顺序为<code>SimulateProposal</code>-&gt;<code>endorser.callChaincode</code>-&gt;<code>endorser.support.Execute</code>-&gt;<code>endorser.support.ChaincodeSupport.Execute</code>-&gt;<code>ChaincodeSupport.Invoke</code>-&gt;<code>ChaincodeSupport.execute</code>-&gt;<code>cs.HandlerRegistry.Handler(cname).Execute</code><br>在这里，首先关键方法是<code>e.callChaincode</code><br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/ call specified chaincode (system or user)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Endorser)</span> <span class="title">callChaincode</span><span class="params">(ctxt context.Context, chainID <span class="keyword">string</span>, version <span class="keyword">string</span>, txid <span class="keyword">string</span>, signedProp *pb.SignedProposal, prop *pb.Proposal, cis *pb.ChaincodeInvocationSpec, cid *pb.ChaincodeID, txsim ledger.TxSimulator)</span> <span class="params">(*pb.Response, *pb.ChaincodeEvent, error)</span></span> &#123;</span><br><span class="line">    ctxt = context.WithValue(ctxt, chaincode.TXSimulatorKey, txsim)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// is this a system chaincode</span></span><br><span class="line">    scc := e.s.IsSysCC(cid.Name)</span><br><span class="line">    res, ccevent, err = e.s.Execute(ctxt, chainID, cid.Name, version, txid, scc, signedProp, prop, cis)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ----- BEGIN -  SECTION THAT MAY NEED TO BE DONE IN LSCC ------</span></span><br><span class="line">    <span class="comment">// if this a call to deploy a chaincode, We need a mechanism</span></span><br><span class="line">    <span class="comment">// to pass TxSimulator into LSCC. Till that is worked out this</span></span><br><span class="line">    <span class="comment">// special code does the actual deploy, upgrade here so as to collect</span></span><br><span class="line">    <span class="comment">// all state under one TxSimulator</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NOTE that if there's an error all simulation, including the chaincode table changes in lscc will be thrown away</span></span><br><span class="line">    <span class="keyword">if</span> cid.Name == <span class="string">"lscc"</span> &amp;&amp; <span class="built_in">len</span>(cis.ChaincodeSpec.Input.Args) &gt;= <span class="number">3</span> &amp;&amp; (<span class="keyword">string</span>(cis.ChaincodeSpec.Input.Args[<span class="number">0</span>]) == <span class="string">"deploy"</span> || <span class="keyword">string</span>(cis.ChaincodeSpec.Input.Args[<span class="number">0</span>]) == <span class="string">"upgrade"</span>) &#123;</span><br><span class="line">        userCDS, err := putils.GetChaincodeDeploymentSpec(cis.ChaincodeSpec.Input.Args[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">// this should not be a system chaincode</span></span><br><span class="line"></span><br><span class="line">        _, _, err = e.s.Execute(ctxt, chainID, cds.ChaincodeSpec.ChaincodeId.Name, cds.ChaincodeSpec.ChaincodeId.Version, txid, <span class="literal">false</span>, signedProp, prop, cds)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ----- END -------</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res, ccevent, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此处将模拟器<code>txsim</code>加入context。此处存在两次调用<code>endorser.support.Execute</code>.第一次调用的是外层的<code>ChaincodeInvokeSpec</code>cis。在<code>endorser.support.Execute</code>里先构建<code>ccprovider.NewCCContext</code>（cccid），这里的<code>cccid.canonicalName</code>设置为<code>name + &quot;:&quot; + version</code>，即lscc:latest。然后获取系统定义的<code>decorator</code>，这个是在node启动时<code>peer/node.go#Serve</code>里初始化的，从配置文件<code>core.yaml</code>里读取配置。配置文件里的定义:”append or mutate the chaincode input passed to the chaincode”. <code>library: /opt/lib/decorator.so</code>。这里将decorator作用于此cis。下一步就是调用<code>ChaincodeSupport.Execute</code>。<br><code>ChaincodeSupport.Execute</code>先执行<code>ChaincodeSupport.Invoke</code>。在invoke方法里，先执行<code>cs.Launch(ctxt, cccid, spec)</code>。这里执行的chaincode是lscc，系统链码已经在启动阶段launch状态为running了，这个在后面会说到，因此直接返回到<code>ChaincodeSupport.Invoke</code>。然后用<code>chaincodeSpec.Input</code>(这里其实是<code>[&quot;deploy&quot;, &quot;${channelId}&quot;, &quot;${chaincodDeploySpec}&quot;]</code>)构建<code>pb.ChaincodeMessage</code>，进入到<code>Chaincode.execute</code>方法执行<code>cs.execute(ctxt, cccid, ccMsg)</code>。这里的<code>pb.ChaincodeMessage</code>类型为<code>pb.ChaincodeMessage_TRANSACTION</code>(cis).</p>
<blockquote>
<p>Launch starts executing chaincode if it is not already running. This method blocks until the peer side handler gets into ready state or encounters a fatal error. If the chaincode is already running, it simply returns.  </p>
</blockquote>
<p>下面是三个入参的结构<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ctx = context.WithValue(ctx, chaincode.HistoryQueryExecutorKey, historyQueryExecutor)</span><br><span class="line">ctxt = context.WithValue(ctxt, chaincode.TXSimulatorKey, txsim)</span><br><span class="line"></span><br><span class="line">cccid := &amp;CCContext&#123;</span><br><span class="line">    ChainID:             cname,		<span class="comment">// channelID</span></span><br><span class="line">    Name:                name,		<span class="comment">// ChaincodeID.name (lscc)</span></span><br><span class="line">    Version:             version,	<span class="comment">// metadata.Version (latest)</span></span><br><span class="line">    TxID:                txid,	</span><br><span class="line">    Syscc:               syscc,		<span class="comment">// is this a system chaincode (true)</span></span><br><span class="line">    SignedProposal:      signedProp,	</span><br><span class="line">    Proposal:            prop,		</span><br><span class="line">    canonicalName:       name + <span class="string">":"</span> + version,</span><br><span class="line">    ProposalDecorations: <span class="literal">nil</span>,		</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ccmsg := &amp;pb.ChaincodeMessage&#123;</span><br><span class="line">    Type:      messageType,		<span class="comment">// pb.ChaincodeMessage_TRANSACTION</span></span><br><span class="line">    Payload:   payload,		<span class="comment">// chaincodeSpec.Input (cis.cs.Input)</span></span><br><span class="line">    Txid:      txid,</span><br><span class="line">    ChannelId: cid,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在<code>ChaincodeSupport.execute</code>先判断处理当前chaincode（根据canonicalName区分,lscc:latest）的handler是否已经注册，这个handler注册的过程后面介绍。然后获取这个handler执行。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">Execute</span><span class="params">(ctxt context.Context, cccid *ccprovider.CCContext, msg *pb.ChaincodeMessage, timeout time.Duration)</span> <span class="params">(*pb.ChaincodeMessage, error)</span></span> &#123;</span><br><span class="line">    txctx, err := h.TXContexts.Create(ctxt, msg.ChannelId, msg.Txid, cccid.SignedProposal, cccid.Proposal)</span><br><span class="line">    <span class="keyword">defer</span> h.TXContexts.Delete(msg.ChannelId, msg.Txid)</span><br><span class="line"></span><br><span class="line">    h.setChaincodeProposal(cccid.SignedProposal, cccid.Proposal, msg)</span><br><span class="line"></span><br><span class="line">    h.serialSendAsync(msg, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> ccresp *pb.ChaincodeMessage</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ccresp = &lt;-txctx.ResponseNotifier:</span><br><span class="line">        <span class="comment">// response is sent to user or calling chaincode. ChaincodeMessage_ERROR are typically treated as error</span></span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(timeout):</span><br><span class="line">        err = errors.New(<span class="string">"timeout expired while executing transaction"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ccresp, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// serialSendAsync serves the same purpose as serialSend (serialize msgs so gRPC will be happy). In addition, it is also asynchronous so send-remoterecv--localrecv loop can be nonblocking. Only errors need to be handled and these are handled by communication on supplied error channel. A typical use will be a non-blocking or nil channel</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">serialSendAsync</span><span class="params">(msg *pb.ChaincodeMessage, sendErr <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err := h.serialSend(msg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> sendErr &#123;</span><br><span class="line">                <span class="comment">// provide an error response to the caller</span></span><br><span class="line">                h.Notify(resp)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">Notify</span><span class="params">(msg *pb.ChaincodeMessage)</span></span> &#123;</span><br><span class="line">	tctx := h.TXContexts.Get(msg.ChannelId, msg.Txid)</span><br><span class="line">	tctx.ResponseNotifier &lt;- msg</span><br><span class="line">	tctx.CloseQueryIterators()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// serialSend serializes msgs so gRPC will be happy</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">serialSend</span><span class="params">(msg *pb.ChaincodeMessage)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	h.serialLock.Lock()</span><br><span class="line">	<span class="keyword">defer</span> h.serialLock.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := h.chatStream.Send(msg); err != <span class="literal">nil</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li>构造<code>TransactionContext</code>,其中有个参数为<code>ResponseNotifier: make(chan *pb.ChaincodeMessage, 1),</code>用以异步执行时接收结果。构造前先判断channelID和txId的组合是否已存在，构造过程加锁，避免重复处理。</li>
<li><code>core/chaincode/handler.go#serialSendAsync</code>异步处理，实际上即启用go routine调用<code>handler#serialSend</code>，使用handler.chatStream发送，此处也是grpc调用。错误以及结果都发送到<code>txctx.ResponseNotifie</code>这个chan内(rpc结果通过调用<code>handler#Notify</code>)。由于是异步调用，函数立即返回，处理结果在外层<code>handler.Execute</code>等待从这个chan读取数据，这里也加上了超时的机制。这里的lscc的调用后面再分析。</li>
</ol>
<p>如果这里调用一切正常，流程将退回到<code>callChaincode</code>继续往下走,然后满足“lscc”，参数为“deploy”的条件，所以从cis里的Input参数获取cds并反序列化成<code>ChaincodeDeploymentSpec</code>对象，重复刚才的步骤。这里稍微有些不同的是，这里的<code>pb.ChaincodeMessage</code>类型为<code>pb.ChaincodeMessage_INIT</code>(cds)，并且这个用户自定义的application chaincode需要launch。<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Launch starts executing chaincode if it is not already running. This method</span></span><br><span class="line"><span class="comment">// blocks until the peer side handler gets into ready state or encounters a fatal</span></span><br><span class="line"><span class="comment">// error. If the chaincode is already running, it simply returns.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs *ChaincodeSupport)</span> <span class="title">Launch</span><span class="params">(ctx context.Context, cccid *ccprovider.CCContext, spec ccprovider.ChaincodeSpecGetter)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    cname := cccid.GetCanonicalName()</span><br><span class="line">    <span class="keyword">if</span> cs.HandlerRegistry.Handler(cname) != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UserRunsCC值一直回溯到 node.start#registerChaincodeSupport 里的 userRunsCC := chaincode.IsDevMode()</span></span><br><span class="line">    <span class="comment">// 这个值实际上是配置文件 core.yaml 里的 peer.mode : net，配置文件的描述如下</span></span><br><span class="line">    <span class="comment">//  # In dev mode, user runs the chaincode after starting peer from command line on local machine.</span></span><br><span class="line">    <span class="comment">//  # In net mode, peer will run chaincode in a docker container.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cs.UserRunsCC &amp;&amp; !cccid.Syscc &#123;</span><br><span class="line">        chaincodeLogger.Error(</span><br><span class="line">            <span class="string">"You are attempting to perform an action other than Deploy on Chaincode that is not ready and you are in developer mode."</span>,</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The only user of this context value is the in-process controller used to support system chaincode. </span></span><br><span class="line">    <span class="comment">// context加入“CCHANDLER” : ChaincodeSupport</span></span><br><span class="line">    ctx = context.WithValue(ctx, ccintf.GetCCHandlerKey(), cs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cs.Launcher.Launch(ctx, cccid, spec)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// core/chaincode/runtime_launcher.go</span></span><br><span class="line"><span class="comment">// Launch chaincode with the appropriate runtime.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *RuntimeLauncher)</span> <span class="title">Launch</span><span class="params">(ctx context.Context, cccid *ccprovider.CCContext, spec ccprovider.ChaincodeSpecGetter)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    chaincodeID := spec.GetChaincodeSpec().ChaincodeId</span><br><span class="line">    cds, _ := spec.(*pb.ChaincodeDeploymentSpec)</span><br><span class="line">    <span class="keyword">if</span> cds == <span class="literal">nil</span> &#123;</span><br><span class="line">        cds, err = r.getDeploymentSpec(ctx, cccid, chaincodeID)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cds.CodePackage == <span class="literal">nil</span> &amp;&amp; cds.ExecEnv != pb.ChaincodeDeploymentSpec_SYSTEM &#123;</span><br><span class="line">        ccpack, err := r.PackageProvider.GetChaincode(chaincodeID.Name, chaincodeID.Version)</span><br><span class="line">        cds = ccpack.GetDepSpec()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err := r.start(ctx, cccid, cds)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里需要部署chaincode需要代码code，在instantiate的cds里参数<code>CodePackage</code>为nil,同时<code>ExecEnv</code>=<code>pb.ChaincodeDeploymentSpec_DOCKER</code>。这里是通过<code>r.PackageProvider.GetChaincode(chaincodeID.Name, chaincodeID.Version)</code>获取具体的代码，实际上是<code>core/common/ccprovider/ccprovider.go#GetChaincodeFromPath</code>从本地路径获取，而这些code是在<code>peer chaincode install</code>时由lscc放到本地目录下，在<code>instantiate</code>时按照chaincodeName和chaincodeVersion取出。这里的path为<code>chaincodeInstallPath</code>,这个是peer启动时从配置文件<code>core.yaml</code>里读取的，配置项为<code>peer.fileSystemPath</code>.</p>
<p>然后执行<code>r.start(ctx, cccid, cds)</code>用这部分代码启动。<code>HandlerRegistry.Launching(cname)</code>先注册launching状态，防止被重复部署。接着启动go routine执行<code>r.Runtime.Start(ctx, cccid, cds)</code>。这里首先获取容器启动参数设置，环境变量等配置，这些配置将作用于后续启动的容器。这里需要留意的是，设置了<code>lc.Args = []string{&quot;chaincode&quot;, fmt.Sprintf(&quot;-peer.address=%s&quot;, c.PeerAddress)}</code>，这里是chaincode容器启动的执行命令。然后根据cds的ExecEnv设置选择容器类型，这里共有两种类型，SYSTEM和DOCKER，用户定义的chaincode是启动在docker容器里的。然后开始启动容器的步骤<code>c.Processor.Process(ctxt, vmtype, scr);</code>。先对容器名加锁<code>vmc.lockContainer(ccid.GetName())</code>防止同时执行创建容器操作，然后执行<code>container.StartContainerReq</code>的<code>Do</code>方法。这里的<code>dockercontroller.Start</code>方法是真正创建容器的地方。</p>
<ol>
<li>构造镜像名（需要保证唯一性）和容器名，停止重名的容器（如果存在，stop,kill,remove），然后使用该镜像创建容器。创建过程遇到<code>err == docker.ErrNoSuchImage</code>，事实上这是必须的，因为要保证是第一次部署，当前环境没有该镜像。入参提供了<code>container.Builder</code>，此处尝试重新构建和部署镜像，然后重新创建容器。如果还是失败，则排除了镜像不存在的错误原因，直接返回错误结果。</li>
<li>这里，存在<code>attachStdout := viper.GetBool(&quot;vm.docker.attachStdout&quot;)</code>这个配置，将容器的输出直接到控制台，方便开发调试。</li>
<li>将需要上传的文件传到容器里，这里的文件是各种配置，例如TLS的key和cert。</li>
<li>使用第三方库fsouza/go-dockerclient来启动docker容器<code>err = client.StartContainer(containerName, nil)</code>.</li>
<li>由于启动容器是异步操作，马上返回到<code>runtime_launcher.start</code>，这里是<code>select-cast</code>,等待启动完成的chan信号，或者异常，或者超时。如果启动失败，则停止容器，取消注册<code>RuntimeLauncher.Registry</code>里到handler以及launchState状态。</li>
</ol>
<p>在<code>core/container/dockercontroller/dockercontroller.go:preFormatImageName</code>定义了docker镜像和容器名，其中，镜像名为<code>${NetworkID}-${PeerId}-${ChaincodeName}-${Version}-${Hash}</code>，容器名为<code>${NetworkID}-${PeerId}-${ChaincodeName}-${Version}</code>，其中NetworkID从配置文件core.yml里的<code>peer.NetworkId</code>配置项。</p>
<p><em>这部分docker相关比较繁琐，暂时没有时间精力深入学习和分析源码，可以参考<a href="https://blog.csdn.net/idsuf698987/article/details/78353481" target="_blank" rel="noopener">fabric源码解析20——ACC的部署</a></em></p>

      
    </div>

    

    
    
    

    <div>
      
        <div>
    
        <div style="text-align:right;color:#C0C0C0;font-size:12px;"><a href="https://simplexity.cn/copyright/">@原创版权所有，转载请注明出处</a></div>
    
</div>
      
    </div>

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Hyperledger-Fabric/" rel="tag"><i class="fa fa-tag"></i> Hyperledger Fabric</a>
          
            <a href="/tags/源码分析/" rel="tag"><i class="fa fa-tag"></i> 源码分析</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/02/23/fabric-source-chaincode-instantiate-peer/" rel="next" title="Fabric 1.4源码分析 - chaincode instantiate(2) peer端的调用流程">
                <i class="fa fa-chevron-left"></i> Fabric 1.4源码分析 - chaincode instantiate(2) peer端的调用流程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/24/fabric-source-chaincode-instantiate-chaincode-launch/" rel="prev" title="Fabric 1.4源码分析 - chaincode instantiate(4）chaincode容器启动及注册">
                Fabric 1.4源码分析 - chaincode instantiate(4）chaincode容器启动及注册 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Travis Wong">
            
              <p class="site-author-name" itemprop="name">Travis Wong</p>
              <p class="site-description motion-element" itemprop="description">Simple is Complex</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">42</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/simplexity-ckcclc" title="GitHub &rarr; https://github.com/simplexity-ckcclc" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://blog.csdn.net/ckcclc" title="CSDN &rarr; https://blog.csdn.net/ckcclc" rel="noopener" target="_blank"><i class="fa fa-fw fa-csdn"></i>CSDN</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Travis Wong</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  
    <!-- LOCAL: You can save these files to your site and update links -->

  
  <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitmint.browser.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.css">
<!-- END LOCAL -->

<style>
#gitment-container a {
  border-bottom: none;
}

</style>

<script>
  function renderGitment() {
    var gitment = new Gitmint({
      id: '1551022276000',
      owner: 'simplexity-ckcclc',
      repo: 'gitment-comments',
      
        lang: '' || navigator.language || navigator.systemLanguage || navigator.userLanguage,
      
      oauth: {
      
      
        client_secret: 'ab2011234194ade1678b2b4d771b0aa55e768632',
      
        client_id: 'd91524ebfcf0e898c853'
      }
    });
    gitment.render('gitment-container');
  }

  
    renderGitment();
  
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'; 
      }
      else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  

  

  

  

  

</body>
</html>
